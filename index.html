<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Presupuesto Personal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4f46e5',
              'secondary': '#10b981',
              'accent': '#f97316',
              'background': '#f1f5f9',
              'card': '#ffffff',
              'text-primary': '#1e293b',
              'text-secondary': '#64748b',
            }
          }
        }
      }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dashboard-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-background text-text-primary">

    <!-- Vista de Login -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-card rounded-xl shadow-lg text-center">
            <div class="inline-block bg-primary/10 p-4 rounded-full">
                 <i data-lucide="piggy-bank" class="w-16 h-16 text-primary"></i>
            </div>
            <h2 class="text-3xl font-bold text-primary">Organizador de Finanzas Personales</h2>
            <p class="text-text-secondary">Inicia sesión para continuar</p>
            <form id="login-form" class="space-y-6 text-left">
                <div>
                    <label for="email" class="text-sm font-medium text-text-secondary">Correo Electrónico</label>
                    <input id="email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="tu@correo.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-text-secondary">Contraseña</label>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="********">
                </div>
                 <p id="login-error" class="text-sm text-red-600 hidden"></p>
                <button type="submit" class="w-full py-2 px-4 text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    Ingresar
                </button>
            </form>
        </div>
    </div>

    <!-- Vista Principal de la Aplicación -->
    <div id="app-view" class="hidden">
        <header class="bg-card shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary">Mi Presupuesto</h1>
            <div class="flex items-center gap-4">
                <span id="current-datetime" class="text-sm text-text-secondary hidden md:block"></span>
                <span id="user-email" class="text-text-secondary"></span>
                <button id="change-password-btn" class="px-4 py-2 text-sm text-primary bg-primary/10 rounded-md hover:bg-primary/20 transition-colors">Cambiar Contraseña</button>
                <button id="logout-button" class="px-4 py-2 text-sm text-white bg-accent rounded-md hover:bg-accent/90 transition-colors">Cerrar Sesión</button>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <!-- Navegación por Pestañas -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button class="tab-button active" data-tab="transactions">
                        <i data-lucide="list" class="inline-block w-5 h-5 mr-2"></i>Transacciones
                    </button>
                    <button class="tab-button" data-tab="monthly">
                        <i data-lucide="calendar" class="inline-block w-5 h-5 mr-2"></i>Dashboard Mensual
                    </button>
                    <button class="tab-button" data-tab="annual">
                        <i data-lucide="bar-chart-2" class="inline-block w-5 h-5 mr-2"></i>Dashboard Anual
                    </button>
                    <button class="tab-button" id="admin-tab-btn" data-tab="admin" style="display: none;">
                        <i data-lucide="settings" class="inline-block w-5 h-5 mr-2"></i>Administración
                    </button>
                </nav>
            </div>

            <!-- Contenido de las Pestañas -->
            <div id="transactions-content" class="tab-content">
                <div class="flex justify-end mb-4">
                    <button id="add-transaction-btn" class="flex items-center gap-2 px-4 py-2 text-white bg-secondary rounded-md hover:bg-secondary/90 transition-colors">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        Nueva Transacción
                    </button>
                </div>
                <div class="bg-card p-4 rounded-lg shadow-sm overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Fecha</th>
                                <th scope="col" class="px-6 py-3">Categoría</th>
                                <th scope="col" class="px-6 py-3">Subcategoría</th>
                                <th scope="col" class="px-6 py-3">Detalle</th>
                                <th scope="col" class="px-6 py-3">Monto</th>
                                <th scope="col" class="px-6 py-3">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Filas se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="monthly-content" class="tab-content hidden">
                <div class="bg-card p-4 rounded-lg mb-6 flex items-center gap-4">
                    <label for="month-selector" class="font-semibold">Seleccionar Mes:</label>
                    <input type="month" id="month-selector" class="border border-gray-300 rounded-md p-2">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="dashboard-card"><h3 class="text-text-secondary">Ingresos Totales</h3><p id="monthly-income" class="text-3xl font-bold text-secondary"></p></div>
                    <div class="dashboard-card"><h3 class="text-text-secondary">Gastos Totales</h3><p id="monthly-expense" class="text-3xl font-bold text-accent"></p></div>
                    <div class="dashboard-card"><h3 class="text-text-secondary">Ahorro del Mes</h3><p id="monthly-savings" class="text-3xl font-bold text-primary"></p></div>
                    <div class="dashboard-card"><h3 class="text-text-secondary">Tasa de Ahorro</h3><p id="monthly-savings-rate" class="text-3xl font-bold text-primary"></p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="dashboard-card"><h3 class="text-lg font-semibold mb-4">Gastos por Subcategoría</h3><canvas id="monthly-expenses-chart"></canvas></div>
                    <div class="dashboard-card"><h3 class="text-lg font-semibold mb-4">Fuentes de Ingreso</h3><canvas id="monthly-income-chart"></canvas></div>
                    <div class="dashboard-card"><h3 class="text-lg font-semibold mb-4">Composición de Gastos</h3><canvas id="monthly-composition-chart"></canvas></div>
                    <div class="dashboard-card"><h3 class="text-lg font-semibold mb-4">Métodos de Pago</h3><canvas id="monthly-payment-chart"></canvas></div>
                </div>
            </div>
            
            <div id="annual-content" class="tab-content hidden">
                 <div class="bg-card p-4 rounded-lg mb-6 flex items-center gap-4">
                    <label for="year-selector" class="font-semibold">Seleccionar Año:</label>
                    <select id="year-selector" class="border border-gray-300 rounded-md p-2"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="dashboard-card"><h3 class="text-text-secondary">Ingresos Totales</h3><p id="annual-income" class="text-3xl font-bold text-secondary"></p></div>
                    <div class="dashboard-card"><h3 class="text-text-secondary">Gastos Totales</h3><p id="annual-expense" class="text-3xl font-bold text-accent"></p></div>
                    <div class="dashboard-card"><h3 class="text-text-secondary">Ahorro Total</h3><p id="annual-savings" class="text-3xl font-bold text-primary"></p></div>
                    <div class="dashboard-card"><h3 class="text-text-secondary">Tasa de Ahorro</h3><p id="annual-savings-rate" class="text-3xl font-bold text-primary"></p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="dashboard-card"><h3 class="text-lg font-semibold mb-4">Ingresos vs Gastos por Mes</h3><canvas id="annual-flow-chart"></canvas></div>
                    <div class="dashboard-card"><h3 class="text-lg font-semibold mb-4">Composición Anual de Gastos</h3><canvas id="annual-composition-chart"></canvas></div>
                </div>
            </div>

            <div id="admin-content" class="tab-content hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold mb-4">Gestionar Categorías Maestras</h2>
                        <p class="text-text-secondary mb-6">Los cambios realizados aquí afectarán a todos los usuarios. Agrega o elimina subcategorías y luego haz clic en "Guardar Cambios".</p>
                        <div id="master-categories-container" class="space-y-6"></div>
                        <div class="mt-8 flex justify-end">
                            <button id="save-master-categories-btn" class="px-6 py-2 text-white bg-primary rounded-md hover:bg-primary/90 transition-colors">Guardar Cambios</button>
                        </div>
                    </div>
                     <div class="dashboard-card">
                        <h2 class="text-2xl font-bold mb-4">Gestionar Usuarios y Roles</h2>
                        <p class="text-text-secondary mb-6">Asigna roles a los usuarios registrados en el sistema.</p>
                        <div id="user-roles-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Agregar Transacción -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Nueva Transacción</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="transaction-form">
                <div class="space-y-4">
                    <div>
                        <label for="trans-type" class="block text-sm font-medium text-gray-700">Tipo Principal</label>
                        <select id="trans-type" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md"></select>
                    </div>
                    <div>
                        <label for="trans-category" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select id="trans-category" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md"></select>
                    </div>
                     <div>
                        <label for="trans-subcategory" class="block text-sm font-medium text-gray-700">Subcategoría</label>
                        <select id="trans-subcategory" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md"></select>
                    </div>
                    <div>
                        <label for="trans-amount" class="block text-sm font-medium text-gray-700">Monto</label>
                        <input type="number" id="trans-amount" step="0.01" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="trans-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="trans-date" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                    </div>
                     <div>
                        <label for="trans-payment" class="block text-sm font-medium text-gray-700">Medio de Pago/Cobro</label>
                        <select id="trans-payment" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md"></select>
                    </div>
                    <div>
                        <label for="trans-detail" class="block text-sm font-medium text-gray-700">Detalle (Opcional)</label>
                        <textarea id="trans-detail" rows="2" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md" placeholder="Ej: Compra de supermercado semanal"></textarea>
                    </div>
                    <button id="save-transaction-btn" type="submit" class="w-full py-2 px-4 text-white bg-secondary rounded-md hover:bg-secondary/90 disabled:bg-gray-400">
                        Guardar Transacción
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Cambiar Contraseña -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Cambiar Contraseña</h3>
                <button id="close-password-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="password-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                        <input type="password" id="new-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                        <input type="password" id="confirm-password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                    </div>
                    <p id="password-error" class="text-sm text-red-600 hidden"></p>
                    <button type="submit" class="w-full py-2 px-4 text-white bg-secondary rounded-md hover:bg-secondary/90">Actualizar Contraseña</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
             <h3 id="alert-title" class="text-lg font-bold mb-4">Aviso</h3>
             <p id="alert-message" class="mb-6"></p>
             <div class="flex justify-end">
                <button id="alert-ok-btn" class="px-4 py-2 text-white bg-primary rounded-md hover:bg-primary/90">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title" class="text-lg font-bold mb-4">Confirmar Acción</h3>
            <p id="confirm-message" class="mb-6">¿Estás seguro?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="confirm-ok-btn" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, serverTimestamp, orderBy, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        window.addEventListener('load', () => { if (typeof lucide !== 'undefined') lucide.createIcons() });
        
        window.addEventListener('DOMContentLoaded', () => {
            
            const firebaseConfig = {
                apiKey: "AIzaSyCLEcYRMdwf5GhLxr49ljaPlaRJyOsCK3c",
                authDomain: "mi-presupuesto-web.firebaseapp.com",
                projectId: "mi-presupuesto-web",
                storageBucket: "mi-presupuesto-web.appspot.com",
                messagingSenderId: "362593144629",
                appId: "1:362593144629:web:eb7dd42366e3ab28b7467c"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            let currentUser = null;
            let currentUserRole = 'user';
            let transactionsUnsubscribe = null;
            let allTransactions = [];
            let chartInstances = {};
            let inactivityTimer;
            let datetimeInterval = null;
            let masterCategories = {};
            let isSubmitting = false;
            const paymentMethods = ["Tarjeta de Crédito", "Tarjeta de Débito", "Billetera Digital", "Efectivo", "Transferencia"];

            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const userEmailSpan = document.getElementById('user-email');
            const transactionsTableBody = document.getElementById('transactions-table-body');
            const monthSelector = document.getElementById('month-selector');
            const yearSelector = document.getElementById('year-selector');
            const adminTab = document.getElementById('admin-tab-btn');

            // --- LÓGICA DE MANEJO DE ESTADO DE AUTENTICACIÓN ---
            
            const handleLogin = async (user) => {
                currentUser = user;
                await getUserRole(user.uid);
                const categoriesLoaded = await loadMasterCategories();
                if (!categoriesLoaded) { await signOut(auth); return; }

                appView.style.display = 'block';
                loginView.style.display = 'none';
                userEmailSpan.textContent = user.email;
                if (currentUserRole === 'admin') adminTab.style.display = 'flex'; else adminTab.style.display = 'none';
                
                loadTransactions();
                resetInactivityTimer();
                document.addEventListener('mousemove', resetInactivityTimer);
                document.addEventListener('keydown', resetInactivityTimer);
                
                updateClock();
                if(datetimeInterval) clearInterval(datetimeInterval);
                datetimeInterval = setInterval(updateClock, 1000);
                
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                monthSelector.value = `${year}-${month}`;
                populateYearSelector();
                yearSelector.value = year;
                updateDashboards();
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };

            const handleLogout = () => {
                if (transactionsUnsubscribe) transactionsUnsubscribe();
                if (datetimeInterval) clearInterval(datetimeInterval);
                clearTimeout(inactivityTimer);
                document.removeEventListener('mousemove', resetInactivityTimer);
                document.removeEventListener('keydown', resetInactivityTimer);

                currentUser = null;
                currentUserRole = 'user';
                allTransactions = [];
                
                appView.style.display = 'none';
                loginView.style.display = 'flex';
                adminTab.style.display = 'none';
                userEmailSpan.textContent = '';
                document.getElementById('current-datetime').textContent = '';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };

            onAuthStateChanged(auth, (user) => user ? handleLogin(user) : handleLogout());
            
            // --- EVENT LISTENERS (SE CONFIGURAN UNA SOLA VEZ) ---
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm.email.value;
                const password = loginForm.password.value;
                const loginError = document.getElementById('login-error');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    loginError.classList.add('hidden');
                } catch (error) {
                    loginError.textContent = "Correo o contraseña incorrectos.";
                    loginError.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', () => signOut(auth));
            monthSelector.addEventListener('change', () => updateDashboards());
            yearSelector.addEventListener('change', () => updateDashboards());
            
            setupTabs();
            setupTransactionModal();
            setupPasswordModal();
            setupAdminListeners();

            // --- LÓGICA DE DATOS Y ROLES ---

            async function getUserRole(uid) {
                const userDocRef = doc(db, 'users', uid);
                const userDocSnap = await getDoc(userDocRef);
                const isAdminByEmail = currentUser.email === 'marcocueva@gmail.com';

                if (userDocSnap.exists()) {
                    const currentRoleInDB = userDocSnap.data().role;
                    if (isAdminByEmail && currentRoleInDB !== 'admin') {
                        await setDoc(userDocRef, { role: 'admin' }, { merge: true });
                        currentUserRole = 'admin';
                    } else {
                        currentUserRole = currentRoleInDB || 'user';
                    }
                } else {
                    const initialRole = isAdminByEmail ? 'admin' : 'user';
                    await setDoc(userDocRef, { email: currentUser.email, role: initialRole });
                    currentUserRole = initialRole;
                }
            }
            
            async function loadMasterCategories() {
                try {
                    const docRef = doc(db, "config", "master_categories");
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        masterCategories = docSnap.data().data;
                        return true;
                    } else if (currentUserRole === 'admin') {
                        const defaultCategories = { "Ingreso": { "Ingreso Fijo": ["Sueldo Fijo"], "Ingreso Variable": ["Emprendimiento", "Cachuelos", "Préstamos"] }, "Gasto": { "Gasto Necesario": ["Mercado", "Internet", "Celular", "Transporte", "Seguro", "Cuidado personal", "Renta", "Mascota", "Salud", "Electricidad", "Comida del día", "Pensión Alimentos", "Extras - Hijos/as", "Emergencias"], "Gastos Deseos": ["Desarrollo personal", "Compras", "Ropa", "Regalos", "Suscripciones", "Viajes", "Salidas"] }, "Deuda": { "Deudas": ["Hipoteca", "Préstamo Carro", "Pago Tarjeta", "Préstamo Personal"] } };
                        await setDoc(docRef, { data: defaultCategories });
                        masterCategories = defaultCategories;
                        return true;
                    } else {
                        showAlert("Error de configuración: Las categorías maestras no existen. El administrador debe iniciar sesión primero para crearlas.");
                        return false;
                    }
                } catch (error) {
                    if (error.code === 'permission-denied') showAlert("Error de Permisos: No se pueden leer las categorías. Asegúrate de haber aplicado las reglas de seguridad correctas en tu base de datos de Firebase.");
                    else showAlert("Ocurrió un error inesperado al cargar la configuración.");
                    return false;
                }
            }

            function loadTransactions() {
                if (transactionsUnsubscribe) transactionsUnsubscribe();
                const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
                const q = query(transactionsRef, orderBy("createdAt", "desc"));
                transactionsUnsubscribe = onSnapshot(q, (snapshot) => {
                    allTransactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderTransactionsTable();
                    updateDashboards();
                });
            }

            // --- LÓGICA DE RENDERIZADO Y UI ---
            
            function renderTransactionsTable() {
                 if (allTransactions.length === 0) {
                    transactionsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">No hay transacciones registradas.</td></tr>`;
                    return;
                }
                const tableRowsHtml = allTransactions.map(t => {
                    const amountClass = t.type === 'Ingreso' ? 'text-green-600' : 'text-red-600';
                    const sign = t.type === 'Ingreso' ? '+' : '-';
                    const amount = parseFloat(t.amount);
                    const formattedAmount = isNaN(amount) ? '0.00' : amount.toFixed(2);
                    return `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4">${t.date}</td>
                            <td class="px-6 py-4">${t.category}</td>
                            <td class="px-6 py-4">${t.subcategory}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${t.detail || ''}</td>
                            <td class="px-6 py-4 font-medium ${amountClass}">${sign}S/ ${formattedAmount}</td>
                            <td class="px-6 py-4">
                                <button class="delete-btn px-2 py-1 text-xs font-medium text-red-600 bg-red-100 rounded-md hover:bg-red-200 transition-colors" data-id="${t.id}">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                transactionsTableBody.innerHTML = tableRowsHtml;
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        showConfirmation("¿Estás seguro de que quieres eliminar esta transacción?", async () => {
                            await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id));
                        });
                    });
                });
            }

            function updateDashboards() {
                updateMonthlyDashboard();
                updateAnnualDashboard();
            }

            function updateMonthlyDashboard() {
                const selectedMonth = monthSelector.value;
                const monthlyTransactions = allTransactions.filter(t => t.date.startsWith(selectedMonth));
                const income = monthlyTransactions.filter(t => t.type === 'Ingreso').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = monthlyTransactions.filter(t => t.type !== 'Ingreso').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const savings = income - expense;
                const savingsRate = income > 0 ? ((savings / income) * 100).toFixed(1) : 0;
                document.getElementById('monthly-income').textContent = `S/ ${income.toFixed(2)}`;
                document.getElementById('monthly-expense').textContent = `S/ ${expense.toFixed(2)}`;
                document.getElementById('monthly-savings').textContent = `S/ ${savings.toFixed(2)}`;
                document.getElementById('monthly-savings-rate').textContent = `${savingsRate}%`;
                generateMonthlyExpensesChart(monthlyTransactions);
                generateMonthlyIncomeChart(monthlyTransactions);
                generateMonthlyCompositionChart(monthlyTransactions);
                generateMonthlyPaymentChart(monthlyTransactions);
            }
            function updateAnnualDashboard() {
                const year = yearSelector.value;
                const annualTransactions = allTransactions.filter(t => t.date.startsWith(year));
                const income = annualTransactions.filter(t => t.type === 'Ingreso').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = annualTransactions.filter(t => t.type !== 'Ingreso').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const savings = income - expense;
                const savingsRate = income > 0 ? ((savings / income) * 100).toFixed(1) : 0;
                document.getElementById('annual-income').textContent = `S/ ${income.toFixed(2)}`;
                document.getElementById('annual-expense').textContent = `S/ ${expense.toFixed(2)}`;
                document.getElementById('annual-savings').textContent = `S/ ${savings.toFixed(2)}`;
                document.getElementById('annual-savings-rate').textContent = `${savingsRate}%`;
                generateAnnualFlowChart(annualTransactions);
                generateAnnualCompositionChart(annualTransactions);
            }
            function populateYearSelector() {
                const currentYear = new Date().getFullYear();
                yearSelector.innerHTML = '';
                for (let i = currentYear; i >= currentYear - 5; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelector.appendChild(option);
                }
            }

            function renderChart(canvasId, type, data, options) {
                if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
                const ctx = document.getElementById(canvasId).getContext('2d');
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            }
            function generateMonthlyExpensesChart(transactions) {
                const grouped = transactions.filter(t => t.type !== 'Ingreso').reduce((acc, t) => { acc[t.subcategory] = (acc[t.subcategory] || 0) + parseFloat(t.amount); return acc; }, {});
                renderChart('monthly-expenses-chart', 'bar', { labels: Object.keys(grouped), datasets: [{ label: 'Gastos', data: Object.values(grouped), backgroundColor: '#fb923c' }] }, { indexAxis: 'y', responsive: true });
            }
            function generateMonthlyIncomeChart(transactions) {
                const grouped = transactions.filter(t => t.type === 'Ingreso').reduce((acc, t) => { acc[t.subcategory] = (acc[t.subcategory] || 0) + parseFloat(t.amount); return acc; }, {});
                renderChart('monthly-income-chart', 'bar', { labels: Object.keys(grouped), datasets: [{ label: 'Ingresos', data: Object.values(grouped), backgroundColor: '#34d399' }] }, { responsive: true });
            }
            function generateMonthlyCompositionChart(transactions) {
                const grouped = transactions.filter(t => t.type !== 'Ingreso').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount); return acc; }, {});
                renderChart('monthly-composition-chart', 'doughnut', { labels: Object.keys(grouped), datasets: [{ data: Object.values(grouped), backgroundColor: ['#f87171', '#fbbf24', '#a78bfa'] }] }, { responsive: true });
            }
            function generateMonthlyPaymentChart(transactions) {
                const grouped = transactions.filter(t => t.type !== 'Ingreso').reduce((acc, t) => { acc[t.paymentMethod] = (acc[t.paymentMethod] || 0) + parseFloat(t.amount); return acc; }, {});
                renderChart('monthly-payment-chart', 'pie', { labels: Object.keys(grouped), datasets: [{ data: Object.values(grouped), backgroundColor: ['#60a5fa', '#c084fc', '#f472b6', '#4ade80'] }] }, { responsive: true });
            }
            function generateAnnualFlowChart(transactions) {
                const monthlyData = Array(12).fill(null).map(() => ({ income: 0, expense: 0 }));
                transactions.forEach(t => {
                    const monthIndex = parseInt(t.date.substring(5, 7), 10) - 1;
                    if (t.type === 'Ingreso') monthlyData[monthIndex].income += parseFloat(t.amount); else monthlyData[monthIndex].expense += parseFloat(t.amount);
                });
                renderChart('annual-flow-chart', 'bar', { labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'], datasets: [{ label: 'Ingresos', data: monthlyData.map(d => d.income), backgroundColor: '#34d399' }, { label: 'Gastos', data: monthlyData.map(d => d.expense), backgroundColor: '#f87171' }] }, { responsive: true, scales: { x: { stacked: false }, y: { stacked: false } } });
            }
            function generateAnnualCompositionChart(transactions) {
                const grouped = transactions.filter(t => t.type !== 'Ingreso').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount); return acc; }, {});
                renderChart('annual-composition-chart', 'doughnut', { labels: Object.keys(grouped), datasets: [{ data: Object.values(grouped), backgroundColor: ['#f87171', '#fbbf24', '#a78bfa'] }] }, { responsive: true });
            }

            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                 const updateButtonStyle = (activeButton) => {
                    tabButtons.forEach(btn => btn.className = 'tab-button px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors flex items-center gap-2');
                    activeButton.className = 'tab-button active px-3 py-2 font-medium text-sm rounded-t-lg border-b-2 transition-colors flex items-center gap-2 border-primary text-primary bg-indigo-50';
                };
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        updateButtonStyle(button);
                        const tabName = button.dataset.tab;
                        tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `${tabName}-content`));
                        if (['monthly', 'annual'].includes(tabName)) updateDashboards();
                        if (button.dataset.tab === 'admin' && currentUserRole === 'admin') {
                            renderAdminPanel();
                        }
                    });
                });
                updateButtonStyle(document.querySelector('.tab-button.active'));
            }

            function setupTransactionModal() {
                const modal = document.getElementById('transaction-modal');
                const form = document.getElementById('transaction-form');
                const saveBtn = document.getElementById('save-transaction-btn');
                const typeSelect = document.getElementById('trans-type');
                const categorySelect = document.getElementById('trans-category');
                const subcategorySelect = document.getElementById('trans-subcategory');
                const paymentSelect = document.getElementById('trans-payment');

                document.getElementById('add-transaction-btn').addEventListener('click', () => {
                    form.reset();
                    isSubmitting = false; // Reset submission flag
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Transacción';
                    
                    const formatter = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Lima', year: 'numeric', month: '2-digit', day: '2-digit' });
                    document.getElementById('trans-date').value = formatter.format(new Date());
                    
                    typeSelect.innerHTML = '<option value="">Seleccione...</option>';
                    Object.keys(masterCategories).forEach(type => typeSelect.innerHTML += `<option value="${type}">${type}</option>`);
                    paymentSelect.innerHTML = '<option value="">Seleccione...</option>';
                    paymentMethods.forEach(p => paymentSelect.innerHTML += `<option value="${p}">${p}</option>`);
                    
                    modal.style.display = "flex";
                });
                document.getElementById('close-modal-btn').addEventListener('click', () => modal.style.display = "none");
                
                typeSelect.addEventListener('change', () => {
                    categorySelect.innerHTML = '<option value="">Seleccione...</option>';
                    const selectedType = typeSelect.value;
                    if (selectedType) Object.keys(masterCategories[selectedType]).forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
                    subcategorySelect.innerHTML = '<option value="">Seleccione...</option>';
                });
                categorySelect.addEventListener('change', () => {
                    subcategorySelect.innerHTML = '<option value="">Seleccione...</option>';
                    const selectedType = typeSelect.value, selectedCat = categorySelect.value;
                    if (selectedType && selectedCat && masterCategories[selectedType][selectedCat]) {
                        masterCategories[selectedType][selectedCat].forEach(sub => subcategorySelect.innerHTML += `<option value="${sub}">${sub}</option>`);
                    }
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (isSubmitting) return; // Block multiple submissions
                    
                    isSubmitting = true;
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Guardando...';

                    const newTransaction = { 
                        type: typeSelect.value, 
                        category: categorySelect.value, 
                        subcategory: subcategorySelect.value, 
                        amount: document.getElementById('trans-amount').value, 
                        date: document.getElementById('trans-date').value, 
                        paymentMethod: paymentSelect.value, 
                        detail: document.getElementById('trans-detail').value.trim(), 
                        createdAt: serverTimestamp() 
                    };

                    try {
                        const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
                        await addDoc(transactionsRef, newTransaction);
                        modal.style.display = "none";
                    } catch (error) { 
                        showAlert("No se pudo guardar la transacción.");
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Guardar Transacción';
                        isSubmitting = false; // Re-enable on error
                    }
                });
            }
            
            function setupPasswordModal() {
                const passwordModal = document.getElementById('password-modal'), openBtn = document.getElementById('change-password-btn'), closeBtn = document.getElementById('close-password-modal-btn'), passwordForm = document.getElementById('password-form'), passwordError = document.getElementById('password-error');
                openBtn.addEventListener('click', () => { 
                    passwordForm.reset(); 
                    passwordError.classList.add('hidden'); 
                    passwordModal.style.display = 'flex'; 
                });
                closeBtn.addEventListener('click', () => passwordModal.style.display = 'none');
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newPassword = document.getElementById('new-password').value, confirmPassword = document.getElementById('confirm-password').value;
                    if (newPassword.length < 6) { passwordError.textContent = "La contraseña debe tener al menos 6 caracteres."; passwordError.classList.remove('hidden'); return; }
                    if (newPassword !== confirmPassword) { passwordError.textContent = "Las contraseñas no coinciden."; passwordError.classList.remove('hidden'); return; }
                    passwordError.classList.add('hidden');
                    try {
                        await updatePassword(auth.currentUser, newPassword);
                        passwordModal.style.display = 'none';
                        showAlert("¡Contraseña actualizada con éxito!");
                    } catch (error) { console.error("Error al cambiar contraseña:", error); passwordError.textContent = "Ocurrió un error. Es posible que necesites volver a iniciar sesión para realizar esta acción."; passwordError.classList.remove('hidden'); }
                });
            }
            
            function setupAdminListeners() {
                document.getElementById('save-master-categories-btn').addEventListener('click', async () => {
                    if (currentUserRole !== 'admin') return;
                    try {
                        await setDoc(doc(db, "config", "master_categories"), { data: masterCategories });
                        showAlert("Categorías maestras actualizadas con éxito.");
                    } catch (error) {
                        showAlert("No se pudieron guardar los cambios.");
                    }
                });
            }

            function renderAdminPanel() {
                renderMasterCategoriesPanel();
                renderUserRolesPanel();
            }

            async function renderMasterCategoriesPanel() {
                const container = document.getElementById('master-categories-container');
                container.innerHTML = ''; 
                Object.keys(masterCategories).forEach(type => {
                    const typeDiv = document.createElement('div');
                    typeDiv.className = 'p-4 border rounded-lg bg-slate-50';
                    let typeHtml = `<h3 class="text-xl font-bold text-primary mb-3">${type}</h3>`;
                    Object.keys(masterCategories[type]).forEach(category => {
                        typeHtml += `<div class="ml-4 mb-4"><h4 class="font-semibold text-text-primary">${category}</h4><ul class="list-disc ml-5 mt-2 text-sm text-text-secondary space-y-1">
                            ${masterCategories[type][category].map(sub => `<li class="flex items-center justify-between"><span>${sub}</span><button data-type="${type}" data-category="${category}" data-sub="${sub}" class="admin-delete-subcategory-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none">&times;</button></li>`).join('')}
                        </ul></div>`;
                    });
                    typeHtml += `<div class="mt-4 ml-4 p-2 border-t"><p class="text-sm font-medium mb-2">Añadir Nueva Subcategoría</p><div class="flex gap-2 items-center">
                        <select class="admin-category-select border rounded-md p-2 text-sm w-1/3">${Object.keys(masterCategories[type]).map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select>
                        <input type="text" placeholder="Nombre de subcategoría" class="admin-subcategory-input border rounded-md p-2 text-sm flex-grow">
                        <button class="admin-add-subcategory-btn bg-secondary text-white text-sm px-3 py-2 rounded-md hover:bg-secondary/90" data-type="${type}">Añadir</button>
                    </div></div>`;
                    typeDiv.innerHTML = typeHtml;
                    container.appendChild(typeDiv);
                });
                container.querySelectorAll('.admin-add-subcategory-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const type = e.target.dataset.type, parentDiv = e.target.closest('.flex'), category = parentDiv.querySelector('.admin-category-select').value, input = parentDiv.querySelector('.admin-subcategory-input'), newSubcategory = input.value.trim();
                    if (newSubcategory && category && !masterCategories[type][category].includes(newSubcategory)) { masterCategories[type][category].push(newSubcategory); renderMasterCategoriesPanel(); }
                    input.value = '';
                }));
                container.querySelectorAll('.admin-delete-subcategory-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const { type, category, sub } = e.target.dataset, index = masterCategories[type][category].indexOf(sub);
                    if (index > -1) { masterCategories[type][category].splice(index, 1); renderMasterCategoriesPanel(); }
                }));
            }

            async function renderUserRolesPanel() {
                const container = document.getElementById('user-roles-container');
                container.innerHTML = `<div class="text-center p-4">Cargando usuarios...</div>`;
                try {
                    const usersCollection = collection(db, 'users');
                    const userSnapshot = await getDocs(usersCollection);
                    const usersList = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    container.innerHTML = usersList.map(user => {
                        const isAdmin = user.role === 'admin', isDisabled = user.id === currentUser.uid ? 'disabled' : '';
                        return `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-md"><span class="text-sm font-medium">${user.email}</span>
                            <select data-uid="${user.id}" class="role-select border rounded-md p-1 text-sm bg-white disabled:bg-gray-200" ${isDisabled}>
                                <option value="user" ${!isAdmin ? 'selected' : ''}>Usuario</option><option value="admin" ${isAdmin ? 'selected' : ''}>Administrador</option>
                            </select></div>`;
                    }).join('');
                    container.querySelectorAll('.role-select').forEach(select => {
                        select.addEventListener('change', (e) => {
                            const newRole = e.target.value, uid = e.target.dataset.uid;
                            showConfirmation(`¿Seguro que quieres cambiar el rol a "${newRole}"?`, async () => {
                                 try { await setDoc(doc(db, 'users', uid), { role: newRole }, { merge: true }); showAlert("Rol actualizado con éxito."); } 
                                 catch (error) { showAlert("No se pudo actualizar el rol."); renderUserRolesPanel(); }
                            });
                        });
                    });
                } catch (error) {
                    let errorMessage = "Error al cargar usuarios.";
                    if (error.code === 'permission-denied') errorMessage += " Verifique que las reglas de seguridad de Firestore estén actualizadas correctamente.";
                    container.innerHTML = `<div class="text-center p-4 text-red-500">${errorMessage}</div>`;
                }
            }

            // --- Utilidades ---
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => showAlert("Se ha cerrado la sesión por inactividad.", () => signOut(auth)), 10 * 60 * 1000); 
            }
            function updateClock() {
                const now = new Date();
                const options = { timeZone: 'America/Lima', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };
                const formatter = new Intl.DateTimeFormat('es-PE', options);
                const capitalizedDate = formatter.format(now).replace(/^\w/, c => c.toUpperCase());
                document.getElementById('current-datetime').textContent = capitalizedDate;
            }
             function showAlert(message, onOk) {
                const modal = document.getElementById('alert-modal'), msg = document.getElementById('alert-message'), okBtn = document.getElementById('alert-ok-btn');
                msg.textContent = message; modal.style.display = 'flex';
                okBtn.onclick = () => { modal.style.display = 'none'; if (onOk) onOk(); };
            }
            function showConfirmation(message, onConfirm) {
                const modal = document.getElementById('confirm-modal'), msg = document.getElementById('confirm-message'), okBtn = document.getElementById('confirm-ok-btn'), cancelBtn = document.getElementById('confirm-cancel-btn');
                msg.textContent = message; modal.style.display = 'flex';
                const onOkClick = () => { onConfirm(); cleanup(); }, onCancelClick = () => cleanup();
                const cleanup = () => { modal.style.display = 'none'; okBtn.removeEventListener('click', onOkClick); cancelBtn.removeEventListener('click', onCancelClick); };
                okBtn.addEventListener('click', onOkClick, { once: true }); cancelBtn.addEventListener('click', onCancelClick, { once: true });
            }
        });
    </script>
</body>
</html>

